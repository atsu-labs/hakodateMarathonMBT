# Development Guide

This guide provides detailed instructions for developing and deploying the Hakodate Marathon MBT application.

## Prerequisites

- Node.js (v18 or higher)
- npm (v9 or higher)
- Cloudflare account (for deployment)
- Wrangler CLI (included in dependencies)

## Initial Setup

### 1. Install Dependencies

```bash
npm install
```

This will install dependencies for both the frontend and backend workspaces.

### 2. Set Up Cloudflare D1 Database

Before deploying or running in production mode, you need to create a D1 database:

```bash
cd backend
npx wrangler d1 create hakodate-marathon-db
```

This command will output something like:

```
✅ Successfully created DB 'hakodate-marathon-db'!

[[d1_databases]]
binding = "DB"
database_name = "hakodate-marathon-db"
database_id = "xxxx-xxxx-xxxx-xxxx-xxxx"
```

### 3. Update Wrangler Configuration

Edit `backend/wrangler.toml` and update the following fields:

```toml
account_id = "your-cloudflare-account-id"

[[d1_databases]]
binding = "DB"
database_name = "hakodate-marathon-db"
database_id = "your-database-id-from-step-2"
```

### 4. Initialize Database Schema

Apply the database schema to your D1 database:

```bash
cd backend
npx wrangler d1 execute hakodate-marathon-db --file=./database/schema.sql
```

For local development, you can also use:

```bash
npx wrangler d1 execute hakodate-marathon-db --local --file=./database/schema.sql
```

## Development Workflow

### Running the Application

#### Option 1: Run Backend with Built Frontend (Recommended)

This mode serves the production build of the frontend through the Hono backend:

```bash
# Build the frontend first
npm run build

# Start the backend dev server
npm run dev
```

Access the application at: `http://localhost:8787`

#### Option 2: Run Frontend and Backend Separately

For faster frontend development with hot module replacement:

Terminal 1 (Frontend):
```bash
npm run dev:frontend
```

Terminal 2 (Backend):
```bash
npm run dev:backend
```

In this mode:
- Frontend dev server runs at: `http://localhost:5173`
- Backend API server runs at: `http://localhost:8787`
- Configure CORS if needed or use the frontend dev server proxy

### Building the Application

Build both frontend and backend:

```bash
npm run build
```

This will:
1. Build the Vue frontend with Vite
2. Output static files to `backend/public/`

### Project Structure

```
hakodateMarathonMBT/
├── frontend/                 # Vue + Vite frontend
│   ├── src/
│   │   ├── components/      # Vue components
│   │   │   └── HelloWorld.vue
│   │   ├── assets/          # Static assets (images, etc.)
│   │   ├── App.vue          # Root component
│   │   ├── main.js          # Entry point
│   │   └── style.css        # Global styles
│   ├── public/              # Public static files
│   ├── index.html           # HTML template
│   ├── vite.config.js       # Vite configuration
│   └── package.json
│
├── backend/                 # Hono backend for Cloudflare Workers
│   ├── src/
│   │   └── index.js         # Hono app and API routes
│   ├── database/
│   │   └── schema.sql       # D1 database schema
│   ├── public/              # Built frontend files (generated by Vite)
│   ├── wrangler.toml        # Cloudflare Workers configuration
│   └── package.json
│
├── package.json             # Root workspace configuration
└── README.md
```

## API Endpoints

The backend provides the following API endpoints:

### GET /api/hello

Returns a welcome message.

**Response:**
```json
{
  "message": "Hello from Hono on Cloudflare Workers!"
}
```

### GET /api/items

Fetches all items from the D1 database.

**Response:**
```json
{
  "items": [
    {
      "id": 1,
      "name": "Sample Item 1",
      "created_at": "2024-01-01 00:00:00"
    }
  ]
}
```

### POST /api/items

Adds a new item to the D1 database.

**Request Body:**
```json
{
  "name": "New Item"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Item added"
}
```

## Deployment

### Deploy to Cloudflare Workers

```bash
npm run deploy
```

This command will:
1. Build the frontend
2. Deploy the entire application to Cloudflare Workers

### First Time Deployment

1. Make sure you're logged in to Cloudflare:
```bash
cd backend
npx wrangler login
```

2. Deploy the application:
```bash
npm run deploy
```

3. Your application will be available at:
```
https://hakodate-marathon-mbt.<your-subdomain>.workers.dev
```

## Troubleshooting

### D1 Database Not Found

If you see errors about the database not being found:

1. Verify the database was created:
```bash
cd backend
npx wrangler d1 list
```

2. Ensure `wrangler.toml` has the correct `database_id`

3. For local development, use the `--local` flag:
```bash
npx wrangler dev --local
```

### CORS Issues During Development

If you're running frontend and backend separately and encounter CORS issues:

1. Use the frontend dev server at `http://localhost:5173` (it proxies to backend)
2. Or add CORS headers to the backend in `backend/src/index.js`:

```javascript
import { cors } from 'hono/cors'

app.use('/api/*', cors())
```

### Build Fails

If the build fails:

1. Clear the build directory:
```bash
rm -rf backend/public/*
```

2. Reinstall dependencies:
```bash
rm -rf node_modules package-lock.json
npm install
```

3. Rebuild:
```bash
npm run build
```

## Testing the API

You can test the API endpoints using curl or any HTTP client:

```bash
# Test the hello endpoint
curl http://localhost:8787/api/hello

# Get all items
curl http://localhost:8787/api/items

# Add a new item
curl -X POST http://localhost:8787/api/items \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Item"}'
```

## Additional Resources

- [Vite Documentation](https://vitejs.dev/)
- [Vue 3 Documentation](https://vuejs.org/)
- [Hono Documentation](https://hono.dev/)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
